name: Run Product Tracker (Linode)

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: env
    timeout-minutes: 60   # ⏱️ HARD KILL SWITCH

    steps:
      - uses: actions/checkout@v4

      # --------------------------------------------------
      # 1. Render cloud-init with secrets
      # --------------------------------------------------
      - name: Render cloud-init
        env:
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        run: |
          envsubst '${MYSQL_USERNAME} ${MYSQL_PASSWORD} ${MYSQL_HOST}' \
            < .github/workflows/cloud-init_template.yaml \
            > .github/workflows/cloud-init.yaml

      # --------------------------------------------------
      # 2. Install Linode CLI
      # --------------------------------------------------
      - name: Install Linode CLI
        uses: linode/action-linode-cli@v1.1.0
        with:
          token: ${{ secrets.LINODE_TOKEN }}

      # --------------------------------------------------
      # 3. Create Linode
      # --------------------------------------------------
      - name: Deploy Linode with cloud-init user data
        id: create
        run: |
          RESPONSE=$(linode-cli linodes create \
            --root_pass "${{ secrets.ROOT_PASSWORD }}" \
            --image "linode/ubuntu22.04" \
            --region "us-lax" \
            --type "g6-nanode-1" \
            --label "product-tracker-${{ github.run_id }}" \
            --metadata.user_data "$(base64 -w 0 .github/workflows/cloud-init.yaml)" \
            --json)

          echo "$RESPONSE"

          LINODE_ID=$(echo "$RESPONSE" | jq -r '.[0].id')
          LINODE_IP=$(echo "$RESPONSE" | jq -r '.[0].ipv4[0]')

          echo "linode_id=$LINODE_ID" >> $GITHUB_OUTPUT
          echo "ip=$LINODE_IP" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # 4. Wait for SSH
      # --------------------------------------------------
      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no \
                   -o ConnectTimeout=5 \
                   root@${{ steps.create.outputs.ip }} "echo SSH ready"; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      # --------------------------------------------------
      # 5. Wait for systemd completion
      # --------------------------------------------------
      - name: Wait for run-product-tracker.service
        run: |
          for i in {1..60}; do
            STATUS=$(ssh -o StrictHostKeyChecking=no \
              ssh root@${{ steps.create.outputs.ip }} \
              "systemctl is-active run-product-tracker.service || true")

            echo "Attempt $i: $STATUS"

            if [ "$STATUS" = "inactive" ]; then
              exit 0
            fi
            sleep 60
          done
          exit 1

      # --------------------------------------------------
      # 6. Destroy Linode (success path)
      # --------------------------------------------------
      - name: Destroy Linode
        if: success()
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          LINODE_ID: ${{ steps.create.outputs.linode_id }}
        run: |
          curl -sS -X DELETE \
            -H "Authorization: Bearer $LINODE_TOKEN" \
            https://api.linode.com/v4/linode/instances/$LINODE_ID

      # --------------------------------------------------
      # 7. Failsafe cleanup (ALWAYS)
      # --------------------------------------------------
      - name: Destroy Linode (failsafe)
        if: always()
        env:
          LINODE_TOKEN: ${{ secrets.LINODE_TOKEN }}
          LINODE_ID: ${{ steps.create.outputs.linode_id }}
        run: |
          [ -z "$LINODE_ID" ] && exit 0
          curl -sS -X DELETE \
            -H "Authorization: Bearer $LINODE_TOKEN" \
            https://api.linode.com/v4/linode/instances/$LINODE_ID || true
