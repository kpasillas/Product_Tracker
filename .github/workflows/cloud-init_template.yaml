#cloud-config

############################
# 1. SYSTEM BOOTSTRAP
############################

package_update: true
package_upgrade: true

packages:
  - software-properties-common
  - git
  - curl
  - build-essential
  - ca-certificates
  - chromium-browser
  - chromium-chromedriver
  - libssl-dev
  - zlib1g-dev
  - libbz2-dev
  - libreadline-dev
  - libsqlite3-dev
  - libncursesw5-dev
  - xz-utils
  - tk-dev
  - libxml2-dev
  - libxmlsec1-dev
  - libffi-dev
  - liblzma-dev

############################
# Users
############################
users:
  - default
  - name: kpasillas
    gecos: Product Tracker User
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: sudo
    lock_passwd: true

############################
# 3. SYSTEMD SERVICE
############################

write_files:
  - path: /etc/systemd/system/product-tracker.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Product Tracker Application
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=kpasillas
      WorkingDirectory=/home/kpasillas/Product_Tracker
      Environment=HOME=/home/kpasillas
      Environment=PYENV_ROOT=/home/kpasillas/.pyenv
      Environment=PATH=/home/kpasillas/.pyenv/shims:/home/kpasillas/.pyenv/bin:/usr/bin:/bin
      ExecStart=/home/kpasillas/Product_Tracker/.venv/bin/python run_product_tracker.py
      Restart=on-failure
      RestartSec=5
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  - path: /home/kpasillas/Product_Tracker/.env
    owner: kpasillas:kpasillas
    permissions: '0600'
    content: |
      MYSQL_USERNAME='MYSQL_USERNAME'
      MYSQL_PASSWORD='MYSQL_PASSWORD'
      MYSQL_HOST='MYSQL_HOST'

  - path: /usr/local/bin/product-tracker-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      USER="kpasillas"
      HOME_DIR="/home/${USER}"
      APP_DIR="${HOME_DIR}/Product_Tracker"
      PYTHON="/usr/local/bin/python3.13"

      export PYENV_ROOT="$HOME/.pyenv"
      export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init --path)"
      eval "$(pyenv init -)"

      echo "=== Product Tracker setup starting ==="

      echo "Build pyenv"
      if [ ! -d "$PYENV_ROOT" ]; then
        echo "Build pyenv - Start"
        curl -fsSL https://pyenv.run | bash

        echo "Build Python - Start"
        pyenv install 3.13.5
        pyenv global 3.13.5
        echo $(python --version)
        echo "Build Python - Finish"
        
        echo "Build pyenv - exit"
        exit
        echo "Build pyenv - Finish"
      fi

      # echo "Git clone"
      # if [ ! -d "${APP_DIR}" ]; then
      #   echo "Git Clone - Start"
      #   sudo -u "${USER}" git clone https://github.com/kpasillas/Product_Tracker.git "${APP_DIR}"
      #   echo "Git Clone - Finish"

      #   # echo "Setup env - Start"
      #   # cd "${HOME_DIR}"
      #   # echo $(ls -lah)
      #   # mv /.env ${APP_DIR}
      #   # echo "Setup env - Finish"

      #   echo "Setup venv - Start"
      #   cd ${APP_DIR}
      #   echo "Create venv"
      #   python -m venv .venv
      #   echo "Activate venv"
      #   source .venv/bin/activate
      #   echo "Install pip packages"
      #   pip install --upgrade pip
      #   pip install -r requirements.txt
      #   echo "Setup venv - Finish"

      #   # echo "run_product_tracker.py - Start"
      #   # python run_product_tracker.py
      #   # echo "run_product_tracker.py - Finish"
      # fi

      # ---- Setup marker ----
      touch "$HOME_DIR/.product_tracker_setup_done"

      echo "=== Product Tracker setup complete ==="

############################
# 5. EXECUTION + REBOOT LOGIC
############################

# runcmd:
  - |
    if [ ! -d /home/kpasillas/Product_Tracker ]; then
      mkdir -p /home/kpasillas/Product_Tracker
      chown -R kpasillas:kpasillas /home/kpasillas
    fi
  
  # - echo "product-tracker-setup - Start"
  # - /usr/local/bin/product-tracker-setup.sh
  # - echo "product-tracker-setup - Finish"

  # - echo "product-tracker.service - Start"
  # - systemctl daemon-reload
  # - sudo -u kpasillas /usr/local/bin/product-tracker-setup.sh
  # - systemctl enable product-tracker.service
  # - systemctl start product-tracker.service
  # - echo "product-tracker.service - Finish"
  
  - |
    if [ -f /var/run/reboot-required ]; then
      echo "Reboot required - Start"
      echo "Reboot required, rebooting..."
      reboot
      echo "Reboot required - Finish"
    fi
