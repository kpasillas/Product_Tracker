name: Run Product Tracker (Linode)

on:
  schedule:
    - cron: "47 17 * * *"
    - cron: "0 13 * * *"
    - cron: "0 20 * * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: env

    steps:
      - uses: actions/checkout@v4

      # --------------------------------------------------
      # 1. Render cloud-init with secrets
      # --------------------------------------------------
      - name: Render cloud-init
        env:
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        run: |
          envsubst '${MYSQL_USERNAME} ${MYSQL_PASSWORD} ${MYSQL_HOST}' \
            < .github/workflows/cloud-init_template.yaml \
            > .github/workflows/cloud-init.yaml


      
      # --------------------------------------------------
      # 2. Generate SSH key
      # --------------------------------------------------
      - name: Generate SSH key
        run: |
          ssh-keygen -t ed25519 -f /tmp/linode_ssh -N ""


      # --------------------------------------------------
      # 3. Install Linode CLI
      # --------------------------------------------------
      - name: Install Linode CLI
        uses: linode/action-linode-cli@v1.1.0
        with:
          token: ${{ secrets.LINODE_TOKEN }}

      # --------------------------------------------------
      # 4. Deploy Linode with cloud-init user data
      # --------------------------------------------------
      - name: Deploy Linode with cloud-init user data
        id: create
        run: |
          LINODE_JSON=$(linode-cli linodes create \
            --root_pass "${{ secrets.ROOT_PASSWORD }}" \
            --image "linode/ubuntu22.04" \
            --region "us-lax" \
            --type "g6-nanode-1" \
            --label "product-tracker-${{ github.run_id }}" \
            --authorized_keys "$(cat /tmp/linode_ssh.pub)" \
            --metadata.user_data "$(base64 -w 0 .github/workflows/cloud-init.yaml)" \
            --json)
      
          LINODE_ID=$(echo "$LINODE_JSON" | jq -r '.[0].id')
          LINODE_IP=$(echo "$LINODE_JSON" | jq -r '.[0].ipv4[0]')
      
          echo "LINODE_ID=$LINODE_ID" >> $GITHUB_ENV
          echo "LINODE_IP=$LINODE_IP" >> $GITHUB_ENV

      # --------------------------------------------------
      # 5. Wait for SSH
      # --------------------------------------------------
      - name: Wait for SSH
        run: |
          for i in {1..60}; do
            if ssh -i /tmp/linode_ssh \
                  -o StrictHostKeyChecking=no \
                  -o ConnectTimeout=5 \
                  root@"$LINODE_IP" "echo SSH ready"; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      # --------------------------------------------------
      # 6. Wait for systemd completion
      # --------------------------------------------------
      - name: Wait for run-product-tracker.service
        run: |
          echo "Waiting for run-product-tracker.service to complete..."

          for i in {1..60}; do
            echo "Attempt: $i"
            
            DONE=$(ssh -i /tmp/linode_ssh \
              -o StrictHostKeyChecking=no \
              root@$"$LINODE_IP" \
              "[ -f /run/product-tracker/completed ] && echo yes || echo no")
          
            if [[ "$DONE" == "yes" ]]; then
              echo "âœ… run-product-tracker finished"
              break
            fi
          
            sleep 60
          done

      # --------------------------------------------------
      # 7. Destroy Linode
      # --------------------------------------------------
      - name: Destroy Linode
        if: always()
        run: |
          linode-cli linodes delete "$LINODE_ID"
