#cloud-config

############################
# 1. SYSTEM BOOTSTRAP
############################

package_update: true
package_upgrade: true

packages:
  - software-properties-common
  - git
  - curl
  - build-essential
  - ca-certificates
  - chromium-browser
  - chromium-chromedriver

############################
# Users
############################
users:
  - default
  - name: kpasillas
    gecos: Product Tracker User
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: sudo
    lock_passwd: true

############################
# 3. SYSTEMD SERVICE
############################

write_files:
  - path: /etc/systemd/system/product-tracker.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Run Product Tracker
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=kpasillas
      WorkingDirectory=/home/kpasillas/Product_Tracker
      Environment=PYTHONUNBUFFERED=1
      ExecStart=/home/kpasillas/Product_Tracker/.venv/bin/python run_product_tracker.py
      StandardOutput=journal
      StandardError=journal
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target

############################
# 4. APP SETUP SCRIPT
############################

  - path: /usr/local/bin/product-tracker-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      USER="kpasillas"
      HOME_DIR="/home/${USER}"
      APP_DIR="${HOME_DIR}/Product_Tracker"
      PYTHON="/usr/bin/python3.13"

      echo "=== Product Tracker setup starting ==="

      # Build Python 3.13.5
      if [ ! [ "$(python3.13 --version 2>&1)" =~ "Python 3.13" ] ]; then
        cd /usr/src
        curl -O https://www.python.org/ftp/python/3.13.5/Python-3.13.5.tgz
        tar xzf Python-3.13.5.tgz
        cd Python-3.13.5
        ./configure --enable-optimizations
        make -j$(nproc)
        make altinstall
      fi

      if [ ! -d "${APP_DIR}" ]; then
        sudo -u "${USER}" git clone https://github.com/kpasillas/Product_Tracker.git "${APP_DIR}"
      fi

      sudo -u "${USER}" bash -lc "
        cd ${APP_DIR}
        ${PYTHON} -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
      "

      systemctl daemon-reload
      systemctl enable product-tracker.service

      echo "=== Product Tracker setup complete ==="

############################
# 5. EXECUTION + REBOOT LOGIC
############################

runcmd:
  - /usr/local/bin/product-tracker-setup.sh
  - |
      if [ -f /var/run/reboot-required ]; then
        echo "Reboot required, rebooting..."
        reboot
      else
        systemctl start product-tracker.service
      fi
