#cloud-config

############################
# 1. SYSTEM BOOTSTRAP
############################

package_update: true
package_upgrade: true

apt:
  sources:
    google-chrome:
      source: "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main"
      keyid: 78BD65473CB3BD13

packages:
  - software-properties-common
  - git
  - curl
  - build-essential
  - ca-certificates
  - libssl-dev
  - zlib1g-dev
  - libbz2-dev
  - libreadline-dev
  - libsqlite3-dev
  - libncursesw5-dev
  - xz-utils
  - tk-dev
  - libxml2-dev
  - libxmlsec1-dev
  - libffi-dev
  - liblzma-dev
  - jq
  - google-chrome-stable
  - chromium-chromedriver

############################
# Users
############################
users:
  - default
  - name: kpasillas
    gecos: Product Tracker User
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: sudo
    lock_passwd: true

############################
# 3. write_files
############################

write_files:
  - path: /home/kpasillas/.env
    permissions: "0600"
    content: |
      MYSQL_USERNAME="${MYSQL_USERNAME}"
      MYSQL_PASSWORD="${MYSQL_PASSWORD}"
      MYSQL_HOST="${MYSQL_HOST}"
      SENDGRID_API_KEY="${SENDGRID_API_KEY}"

  # - path: /root/.linode-cli
  #   permissions: "0600"
  #   owner: root:root
  #   content: |
  #     [DEFAULT]
  #     token = ${LINODE_TOKEN}
  #     default-user = DEFAULT
  #     suppress-version-warning = true

  - path: /usr/local/bin/setup-product-tracker.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      USER="kpasillas"
      HOME="/home/${USER}"
      APP_DIR="${HOME}/Product_Tracker"

      export PYENV_ROOT="$HOME/.pyenv"
      export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"

      echo "=== Setup Product Tracker Starting ==="

      if [[ "$HOME" != "/home/kpasillas" ]]; then
        echo "ERROR: Incorrect HOME detected: $HOME"
        exit 1
      fi

      echo "Build pyenv - Start"
      curl -fsSL https://pyenv.run | bash
      eval "$(pyenv init --path)"
      eval "$(pyenv init -)"
      echo "Build pyenv - Finish"

      echo "Build Python - Start"
      pyenv install 3.13.5
      pyenv global 3.13.5
      echo "Build Python - Finish"

      echo "Git Clone - Start"
      sudo -u "${USER}" git clone https://github.com/kpasillas/Product_Tracker.git "${APP_DIR}"
      echo "Git Clone - Finish"

      mv ${HOME}/.env ${APP_DIR}

      echo "Setup venv - Start"
      cd ${APP_DIR}
      echo "Create venv"
      python -m venv .venv
      echo "Activate venv"
      source .venv/bin/activate
      echo "Install pip packages"
      pip install --upgrade pip
      pip install -r requirements.txt
      echo "Setup venv - Finish"

      # ---- Setup marker ----
      touch "$HOME/.setup_product_tracker_done"

      echo "=== Setup Product Tracker Complete ==="

  - path: /etc/systemd/system/setup-product-tracker.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Setup Product Tracker
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      User=kpasillas
      Environment=HOME=/home/kpasillas
      ExecStart=/bin/bash -lc /usr/local/bin/setup-product-tracker.sh

      [Install]
      WantedBy=multi-user.target

  - path: /usr/local/bin/run-product-tracker.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      # -----------------------------
      # Linode metadata helpers
      # -----------------------------
      
      get_metadata_token() {
        curl -s -f -X PUT \
          -H "Metadata-Token-TTL-Seconds: 300" \
          http://169.254.169.254/v1/token
      }
      
      get_instance_metadata() {
        local token="$1"
        curl -s -f \
          -H "Metadata-Token: ${token}" \
          http://169.254.169.254/v1/instance
      }
      
      export LINODE_CLI_TOKEN="${LINODE_TOKEN}"
      
      USER="kpasillas"
      HOME="/home/${USER}"
      APP_DIR="${HOME}/Product_Tracker"
      
      export HOME
      cd "${APP_DIR}"
      
      source .venv/bin/activate

      python run_product_tracker.py

      touch /run/product-tracker/completed

      echo "üèÅ Product tracker finished"
      
      echo "Fetching Linode metadata..."

      LINODE_ID="$(linode-cli linodes list --text | grep "product-tracker" | awk '{print $1}')"
      LINODE_IP="$(linode-cli linodes list --text | grep "product-tracker" | awk '{print $7}')"

      echo "Linode ID: $LINODE_ID"
      echo "Linode IP: $LINODE_IP"

      # echo "üî• Deleting Linode ID: $LINODE_ID"
      
      # if [[ -n "$LINODE_ID" ]]; then
      #   echo "Destroying Linode $LINODE_ID"
      #   linode-cli linodes delete "$LINODE_ID" --yes
      # else
      #   echo "ERROR: LINODE_ID not set ‚Äî skipping self-destruction"
      # fi

  - path: /etc/systemd/system/run-product-tracker.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Run Product Tracker
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=oneshot
      RemainAfterExit=no
      Restart=no
      User=kpasillas
      Environment=HOME=/home/kpasillas
      RuntimeDirectory=product-tracker
      RuntimeDirectoryMode=0700
      RuntimeDirectoryUser=kpasillas
      RuntimeDirectoryGroup=kpasillas
      Environment=XDG_RUNTIME_DIR=/run/product-tracker
      ExecStart=/usr/local/bin/run-product-tracker.sh
      StandardOutput=journal
      StandardError=journal
      PrivateTmp=false
      ProtectHome=false
      
      [Install]
      WantedBy=multi-user.target


############################
# 5. EXECUTION + REBOOT LOGIC
############################

runcmd:
  - echo "runcmd - Start"

  - shutdown -h +360

  - chown -R kpasillas:kpasillas /home/kpasillas
  - chmod 0755 /usr/local/bin/run-product-tracker.sh
  - chown root:root /usr/local/bin/run-product-tracker.sh

  
  - echo "product-tracker.service - Start"
  
  - systemctl daemon-reload
  
  - systemctl enable setup-product-tracker.service
  - systemctl start setup-product-tracker.service

  - systemctl enable run-product-tracker.service
  - systemctl start run-product-tracker.service
  
  - echo "product-tracker.service - Finish"

  - echo "runcmd - Finish"
