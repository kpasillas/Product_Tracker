name: Run Product Tracker (Linode)

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    environment: env
    timeout-minutes: 60   # ⏱️ HARD KILL SWITCH

    steps:
      - uses: actions/checkout@v4

      # --------------------------------------------------
      # 1. Render cloud-init with secrets
      # --------------------------------------------------
      - name: Render cloud-init
        env:
          MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        run: |
          envsubst '${MYSQL_USERNAME} ${MYSQL_PASSWORD} ${MYSQL_HOST}' \
            < .github/workflows/cloud-init_template.yaml \
            > .github/workflows/cloud-init.yaml


      
      # --------------------------------------------------
      # 2. Generate SSH key
      # --------------------------------------------------
      - name: Generate SSH key
        run: |
          ssh-keygen -t ed25519 -f /tmp/linode_ssh -N ""


      # --------------------------------------------------
      # 3. Install Linode CLI
      # --------------------------------------------------
      - name: Install Linode CLI
        uses: linode/action-linode-cli@v1.1.0
        with:
          token: ${{ secrets.LINODE_TOKEN }}

      # --------------------------------------------------
      # 4. Deploy Linode with cloud-init user data
      # --------------------------------------------------
      - name: Deploy Linode with cloud-init user data
        id: create
        run: |
          LINODE_JSON=$(linode-cli linodes create \
            --root_pass "${{ secrets.ROOT_PASSWORD }}" \
            --image "linode/ubuntu22.04" \
            --region "us-lax" \
            --type "g6-nanode-1" \
            --label "product-tracker-${{ github.run_id }}" \
            --authorized_keys "$(cat /tmp/linode_ssh.pub)" \
            --metadata.user_data "$(base64 -w 0 .github/workflows/cloud-init.yaml)" \
            --json)
      
          echo "ip=$(echo "$LINODE_JSON" | jq -r '.[0].ipv4[0]')" >> $GITHUB_OUTPUT
          echo "id=$(echo "$LINODE_JSON" | jq -r '.[0].id')" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # 5. Wait for SSH
      # --------------------------------------------------
      - name: Wait for SSH
        run: |
          for i in {1..60}; do
            if ssh -i /tmp/linode_ssh \
                  -o StrictHostKeyChecking=no \
                  -o ConnectTimeout=5 \
                  root@${{ steps.create.outputs.ip }} "echo SSH ready"; then
              exit 0
            fi
            sleep 10
          done
          exit 1

      # --------------------------------------------------
      # 6. Wait for systemd completion
      # --------------------------------------------------
      - name: Wait for run-product-tracker.service
        run: |
          echo "Waiting for run-product-tracker.service to complete..."

          while true; do
            RESULT=$(ssh -i /tmp/linode_ssh \
              -o StrictHostKeyChecking=no \
              root@${{ steps.create.outputs.ip }} \
              "systemctl show run-product-tracker.service --property=Result --value || true")
          
            echo "Result=$RESULT"
          
            if [[ "$RESULT" == "success" ]]; then
              echo "✅ run-product-tracker completed successfully"
              break
            fi
          
            if [[ "$RESULT" == "exit-code" || "$RESULT" == "signal" ]]; then
              echo "❌ run-product-tracker failed"
              exit 1
            fi
          
            sleep 60
          done

      # --------------------------------------------------
      # 7. Destroy Linode (success path)
      # --------------------------------------------------
      - name: Destroy Linode
        if: success()
        env:
          LINODE_ID: ${{ steps.create.outputs.linode_id }}
        run: |
          echo $LINODE_ID
          linode-cli linodes delete $LINODE_ID

      # --------------------------------------------------
      # 8. Failsafe cleanup (ALWAYS)
      # --------------------------------------------------
      - name: Destroy Linode (failsafe)
        if: always()
        env:
          LINODE_ID: ${{ steps.create.outputs.linode_id }}
        run: |
          echo $LINODE_ID
          linode-cli linodes delete $LINODE_ID
